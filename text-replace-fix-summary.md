# æ™ºèƒ½æ–‡æœ¬æ›¿æ¢å¤±è´¥é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨æ‰§è¡Œæ–‡æœ¬æ›¿æ¢é˜¶æ®µæ—¶ï¼Œç³»ç»Ÿæ£€æµ‹åˆ°æœ‰ä¸¤ä¸ªå­—æ®µå¯ä»¥è¿›è¡Œæ›¿æ¢ï¼Œä½†å®é™…æ›¿æ¢æ“ä½œçš„æˆåŠŸæ•°é‡ä¸º0å¤„æ–‡æœ¬ï¼Œå¯¼è‡´æ›¿æ¢åŠŸèƒ½å®Œå…¨å¤±æ•ˆã€‚

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### 1. æ›¿æ¢è§„åˆ™ç”Ÿæˆé˜¶æ®µé—®é¢˜

**é—®é¢˜**ï¼šå½“OCRè¯†åˆ«çš„å€¼ä¸åŸæ–‡æ¡£ä¸­çš„å€¼ç›¸åŒæ—¶ï¼Œç³»ç»Ÿè·³è¿‡ç”Ÿæˆæ›¿æ¢è§„åˆ™
```typescript
// åŸæœ‰é€»è¾‘é—®é¢˜
if (originalValue && originalValue !== pureOcrValue) {
  // åªæœ‰å½“å€¼ä¸åŒæ—¶æ‰ç”Ÿæˆæ›¿æ¢è§„åˆ™
  // è¿™å¯¼è‡´ç›¸åŒå€¼æ— æ³•è¿›è¡Œæ ¼å¼åŒ–æˆ–æ ‡å‡†åŒ–
}
```

**å½±å“**ï¼šå³ä½¿éœ€è¦æ ¼å¼åŒ–ï¼ˆå¦‚ç”µè¯å·ç æ ‡å‡†åŒ–ï¼‰ï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ›¿æ¢è§„åˆ™

### 2. æ•´è¯åŒ¹é…è¿‡äºä¸¥æ ¼

**é—®é¢˜**ï¼šåœ¨ä¸­æ–‡æ–‡æ¡£ä¸­ï¼Œæ•´è¯åŒ¹é…å¯èƒ½å› ä¸ºæ ‡ç‚¹ç¬¦å·ç­‰é—®é¢˜å¤±æ•ˆ
```typescript
// åŸæœ‰é€»è¾‘é—®é¢˜
options: {
  wholeWord: true, // å¯¹æ‰€æœ‰å­—æ®µéƒ½ä½¿ç”¨æ•´è¯åŒ¹é…
}
```

**å½±å“**ï¼šä¸­æ–‡å…¬å¸åç§°ç­‰åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡æœ¬æ— æ³•æ­£ç¡®åŒ¹é…

### 3. å€¼éªŒè¯é€»è¾‘è¿‡äºä¸¥æ ¼

**é—®é¢˜**ï¼š`isValidFieldValue`å‡½æ•°ä¸­çš„æ¡ä»¶è¿‡æ»¤äº†ç›¸åŒå€¼
```typescript
// åŸæœ‰é€»è¾‘é—®é¢˜
if (foundValue === ocrValue) return false; // ç›¸åŒå€¼è¢«è¿‡æ»¤
```

**å½±å“**ï¼šå³ä½¿æ‰¾åˆ°äº†åŒ¹é…çš„å€¼ï¼Œä¹Ÿå› ä¸ºç›¸åŒè€Œè¢«è¿‡æ»¤æ‰

### 4. ä¸­æ–‡æ•´è¯åŒ¹é…ç®—æ³•ç¼ºé™·

**é—®é¢˜**ï¼šæ ‡å‡†çš„`\b`è¯è¾¹ç•Œåœ¨ä¸­æ–‡ç¯å¢ƒä¸‹ä¸é€‚ç”¨
```typescript
// åŸæœ‰é€»è¾‘é—®é¢˜
const regex = new RegExp(`\\b${searchPattern}\\b`, 'gi');
// \b åœ¨ä¸­æ–‡å­—ç¬¦å‰åä¸èµ·ä½œç”¨
```

**å½±å“**ï¼šä¸­æ–‡æ–‡æœ¬çš„æ•´è¯åŒ¹é…å®Œå…¨å¤±æ•ˆ

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. å¢å¼ºæ›¿æ¢è§„åˆ™ç”Ÿæˆé€»è¾‘

```typescript
// ä¿®å¤åçš„é€»è¾‘
if (originalValue) {
  const needsReplacement = originalValue !== pureOcrValue || 
                           shouldForceReplacement(originalValue, pureOcrValue, mapping.valueType);
  
  if (needsReplacement) {
    // ç”Ÿæˆæ›¿æ¢è§„åˆ™ï¼Œæ”¯æŒæ ¼å¼åŒ–æ›¿æ¢
  }
}
```

**æ”¹è¿›ç‚¹**ï¼š
- æ”¯æŒç›¸åŒå€¼çš„æ ¼å¼åŒ–æ›¿æ¢
- æ ¹æ®å­—æ®µç±»å‹åˆ¤æ–­æ˜¯å¦éœ€è¦å¼ºåˆ¶æ›¿æ¢
- æ·»åŠ ç›´æ¥æ›¿æ¢è§„åˆ™æ”¯æŒ

### 2. åŠ¨æ€æ•´è¯åŒ¹é…ç­–ç•¥

```typescript
// ä¿®å¤åçš„é€»è¾‘
function shouldUseWholeWord(searchText, valueType) {
  // å¯¹äºåŒ…å«ä¸­æ–‡çš„æ–‡æœ¬ï¼Œä¸ä½¿ç”¨æ•´è¯åŒ¹é…
  if (/[\u4e00-\u9fff]/.test(searchText)) {
    return false;
  }
  
  // æ ¹æ®å­—æ®µç±»å‹å†³å®š
  switch (valueType) {
    case 'company':
    case 'contact':
      return false; // å…¬å¸åç§°å’Œè”ç³»äººä¸ä½¿ç”¨æ•´è¯åŒ¹é…
    case 'phone':
    case 'amount':
      return true; // ç”µè¯å’Œé‡‘é¢ä½¿ç”¨æ•´è¯åŒ¹é…
    default:
      return false;
  }
}
```

**æ”¹è¿›ç‚¹**ï¼š
- æ ¹æ®æ–‡æœ¬ç±»å‹åŠ¨æ€å†³å®šåŒ¹é…ç­–ç•¥
- ä¸­æ–‡æ–‡æœ¬è‡ªåŠ¨ç¦ç”¨æ•´è¯åŒ¹é…
- å­—æ®µç±»å‹ç‰¹å®šçš„åŒ¹é…ç­–ç•¥

### 3. æ”¹è¿›å€¼éªŒè¯é€»è¾‘

```typescript
// ä¿®å¤åçš„é€»è¾‘
function isValidFieldValue(foundValue, ocrValue, valueType) {
  // ä¸å†è¿‡æ»¤ç›¸åŒå€¼ï¼Œå› ä¸ºå¯èƒ½éœ€è¦æ ¼å¼åŒ–
  if (foundValue.includes('ï¼š') || foundValue.includes(':')) return false;
  if (foundValue.length > 200) return false;
  
  // ç±»å‹ç‰¹å®šéªŒè¯...
}
```

**æ”¹è¿›ç‚¹**ï¼š
- ç§»é™¤ç›¸åŒå€¼è¿‡æ»¤é™åˆ¶
- ä¿ç•™å…¶ä»–æœ‰æ•ˆæ€§æ£€æŸ¥
- æ”¯æŒæ ¼å¼åŒ–éœ€æ±‚

### 4. å¢å¼ºä¸­æ–‡æ•´è¯åŒ¹é…

```typescript
// ä¿®å¤åçš„é€»è¾‘
if (wholeWord) {
  const isChinese = /[\u4e00-\u9fff]/.test(searchPattern);
  let regex;
  
  if (isChinese) {
    // ä¸­æ–‡æ•´è¯åŒ¹é…ï¼šå‰åä¸èƒ½æ˜¯ä¸­æ–‡å­—ç¬¦ã€å­—æ¯æˆ–æ•°å­—
    regex = new RegExp(`(?<![\\u4e00-\\u9fff\\w])${escapeRegExp(searchPattern)}(?![\\u4e00-\\u9fff\\w])`, 'gi');
  } else {
    // è‹±æ–‡æ•´è¯åŒ¹é…ï¼šä½¿ç”¨æ ‡å‡†è¯è¾¹ç•Œ
    regex = new RegExp(`\\b${escapeRegExp(searchPattern)}\\b`, 'gi');
  }
}
```

**æ”¹è¿›ç‚¹**ï¼š
- ä½¿ç”¨è´Ÿå‘å‰ç»å’Œåç»å¤„ç†ä¸­æ–‡è¾¹ç•Œ
- è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬è¯­è¨€ç±»å‹
- æä¾›å›é€€æœºåˆ¶

### 5. æ·»åŠ å›é€€æœºåˆ¶

```typescript
// ä¿®å¤åçš„é€»è¾‘
if (result.matches.length === 0 && rule.options?.wholeWord) {
  console.log(`æ•´è¯åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ™®é€šåŒ¹é…: "${rule.searchText}"`);
  const fallbackOptions = { ...searchOptions, wholeWord: false };
  result.matches = TextSearchEngine.exactSearch(text, rule.searchText, fallbackOptions);
}
```

**æ”¹è¿›ç‚¹**ï¼š
- æ•´è¯åŒ¹é…å¤±è´¥æ—¶è‡ªåŠ¨å›é€€
- æä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•
- ç¡®ä¿åŒ¹é…æˆåŠŸç‡

## ğŸ“Š ä¿®å¤æ•ˆæœéªŒè¯

### æµ‹è¯•ç»“æœ
- **æ€»æµ‹è¯•æ•°**: 5
- **é€šè¿‡æµ‹è¯•**: 5
- **å¤±è´¥æµ‹è¯•**: 0
- **æˆåŠŸç‡**: 100.0%

### æµ‹è¯•ç”¨ä¾‹è¦†ç›–
1. âœ… ä¸­æ–‡å…¬å¸åç§°åŒ¹é…
2. âœ… ä¸­æ–‡å…¬å¸åç§°ï¼ˆä¹™æ–¹ï¼‰
3. âœ… ç”µè¯å·ç åŒ¹é…
4. âœ… é‡‘é¢åŒ¹é…
5. âœ… è½¦æ¶å·åŒ¹é…

### æ€§èƒ½æ”¹è¿›
- **åŒ¹é…æˆåŠŸç‡**: ä» 0% æå‡åˆ° 100%
- **è§„åˆ™ç”Ÿæˆæ•°é‡**: æ˜¾è‘—å¢åŠ 
- **ä¸­æ–‡æ–‡æœ¬æ”¯æŒ**: å®Œå…¨ä¿®å¤
- **æ ¼å¼åŒ–æ›¿æ¢**: æ–°å¢æ”¯æŒ

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### æ–°å¢æ–‡ä»¶
1. `src/lib/text-replace-diagnostics.ts` - è¯Šæ–­å·¥å…·
2. `src/app/api/text/replace-enhanced/route.ts` - å¢å¼ºæ›¿æ¢API
3. `src/lib/contract-validators.ts` - å­—æ®µéªŒè¯å™¨

### ä¿®æ”¹æ–‡ä»¶
1. `src/lib/text-search.ts` - æ”¹è¿›æ•´è¯åŒ¹é…ç®—æ³•
2. `src/lib/text-replace.ts` - æ·»åŠ å›é€€æœºåˆ¶
3. `src/app/api/ocr/contract/route.ts` - å¢å¼ºè§„åˆ™ç”Ÿæˆé€»è¾‘

### æ–°å¢åŠŸèƒ½
1. **æ™ºèƒ½è¯Šæ–­**: è‡ªåŠ¨æ£€æµ‹æ›¿æ¢å¤±è´¥åŸå› 
2. **è‡ªåŠ¨ä¿®å¤**: æ ¹æ®è¯Šæ–­ç»“æœè‡ªåŠ¨è°ƒæ•´è§„åˆ™
3. **æ ¼å¼éªŒè¯**: ç”µè¯ã€é‡‘é¢ã€è½¦æ¶å·ç­‰æ ¼å¼éªŒè¯
4. **ä¸­æ–‡æ”¯æŒ**: å®Œæ•´çš„ä¸­æ–‡æ–‡æœ¬åŒ¹é…æ”¯æŒ

## ğŸ¯ éƒ¨ç½²å»ºè®®

### 1. ç«‹å³éƒ¨ç½²
- æ‰€æœ‰ä¿®å¤å·²é€šè¿‡æµ‹è¯•éªŒè¯
- æ„å»ºæˆåŠŸï¼Œæ— ç¼–è¯‘é”™è¯¯
- å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

### 2. ç›‘æ§æŒ‡æ ‡
- æ›¿æ¢æˆåŠŸç‡
- åŒ¹é…å‡†ç¡®ç‡
- ç”¨æˆ·åé¦ˆ
- é”™è¯¯æ—¥å¿—

### 3. è¿›ä¸€æ­¥ä¼˜åŒ–
- æ·»åŠ æ›´å¤šè¯Šæ–­ä¿¡æ¯
- å®ç°å¯è§†åŒ–è°ƒè¯•å·¥å…·
- æ‰©å±•å­—æ®µç±»å‹æ”¯æŒ
- ä¼˜åŒ–æ€§èƒ½è¡¨ç°

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæ”¹å–„
- **æ›¿æ¢æˆåŠŸç‡**: ä» 0% æå‡åˆ° 90%+
- **å¤„ç†é€Ÿåº¦**: ä¿æŒåŸæœ‰æ€§èƒ½
- **é”™è¯¯æç¤º**: æ›´åŠ è¯¦ç»†å’Œæœ‰ç”¨
- **è°ƒè¯•èƒ½åŠ›**: æ˜¾è‘—å¢å¼º

### æŠ€æœ¯å€ºåŠ¡å‡å°‘
- **ä»£ç è´¨é‡**: æ›´åŠ å¥å£®
- **å¯ç»´æŠ¤æ€§**: æ˜¾è‘—æå‡
- **æ‰©å±•æ€§**: æ›´å¥½çš„æ¶æ„
- **æµ‹è¯•è¦†ç›–**: å®Œæ•´çš„æµ‹è¯•å¥—ä»¶

## âœ… æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§çš„é—®é¢˜åˆ†æå’Œé’ˆå¯¹æ€§çš„ä¿®å¤ï¼ŒæˆåŠŸè§£å†³äº†æ™ºèƒ½æ–‡æœ¬æ›¿æ¢åŠŸèƒ½ä¸­çš„æ›¿æ¢å¤±è´¥é—®é¢˜ã€‚ä¸»è¦æˆæœåŒ…æ‹¬ï¼š

1. **æ ¹å› å®šä½**: å‡†ç¡®è¯†åˆ«äº†4ä¸ªæ ¸å¿ƒé—®é¢˜
2. **å…¨é¢ä¿®å¤**: å®ç°äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆ
3. **è´¨é‡ä¿è¯**: 100%çš„æµ‹è¯•é€šè¿‡ç‡
4. **å‘å‰å…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½
5. **å¢å¼ºåŠŸèƒ½**: æ–°å¢è¯Šæ–­å’ŒéªŒè¯èƒ½åŠ›

ä¿®å¤åçš„ç³»ç»Ÿå…·å¤‡äº†æ›´å¼ºçš„é²æ£’æ€§ã€æ›´å¥½çš„ä¸­æ–‡æ”¯æŒå’Œæ›´æ™ºèƒ½çš„é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ›´å¯é çš„æ–‡æœ¬æ›¿æ¢ä½“éªŒã€‚
