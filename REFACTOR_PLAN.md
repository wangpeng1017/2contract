# æ™ºèƒ½åˆåŒæ¨¡æ¿ç³»ç»Ÿé‡æ„æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### å½“å‰çŠ¶æ€
- **å‰ç«¯**: Next.js 14 + TypeScript + Tailwind CSS
- **åç«¯**: Next.js API Routes (Vercel Serverless Functions)
- **æ•°æ®åº“**: PostgreSQL + Prisma ORM
- **æ ¸å¿ƒåŠŸèƒ½**: é£ä¹¦æ–‡æ¡£é›†æˆã€OCRè¯†åˆ«ã€æ–‡æœ¬æ›¿æ¢

### é‡æ„ç›®æ ‡
å°†ç³»ç»Ÿé‡æ„ä¸º**ä¸“æ³¨äºåˆåŒæ¨¡æ¿å¤„ç†**çš„åº”ç”¨ï¼Œé‡‡ç”¨å‰åç«¯å®Œå…¨åˆ†ç¦»çš„æ¶æ„ï¼š
- **Python FastAPI** åç«¯ï¼ˆéƒ¨ç½²åœ¨ Leaflowï¼‰
- **Next.js** å‰ç«¯ï¼ˆéƒ¨ç½²åœ¨ Vercelï¼‰
- **æ ¸å¿ƒæµç¨‹**: æ¨¡æ¿ä¸Šä¼  â†’ AIå˜é‡æå– â†’ åŠ¨æ€è¡¨å• â†’ é«˜ä¿çœŸæ–‡æ¡£ç”Ÿæˆ

---

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æµè§ˆå™¨                              â”‚
â”‚                      (Next.js å‰ç«¯)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API ç½‘å…³ & è·¯ç”±å±‚                           â”‚
â”‚                  (FastAPI åç«¯æœåŠ¡)                           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚          â”‚          â”‚          â”‚
     â†“          â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ¨¡å—ä¸€  â”‚ â”‚æ¨¡å—äºŒ  â”‚ â”‚æ¨¡å—ä¸‰  â”‚ â”‚æ¨¡å—å››  â”‚
â”‚æ–‡æ¡£è§£æâ”‚ â”‚AIæå–  â”‚ â”‚è¡¨å•ç”Ÿæˆâ”‚ â”‚æ–‡æ¡£ç”Ÿæˆâ”‚
â”‚python- â”‚ â”‚Lang-   â”‚ â”‚åŠ¨æ€æ˜ å°„â”‚ â”‚python- â”‚
â”‚docx    â”‚ â”‚Extract â”‚ â”‚        â”‚ â”‚docx-   â”‚
â”‚        â”‚ â”‚        â”‚ â”‚        â”‚ â”‚templateâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚          â”‚          â”‚          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   PostgreSQL æ•°æ®åº“    â”‚
         â”‚   (Vercel Postgres)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ         â”‚
         â”‚   (Vercel Blob)       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å››å¤§æ ¸å¿ƒæ¨¡å—è¯¦è§£

### æ¨¡å—ä¸€ï¼šæ¨¡æ¿è§£ææœåŠ¡ (Document Parser)

**æŠ€æœ¯æ ˆ**: `python-docx`

**åŠŸèƒ½èŒè´£**:
1. æ¥æ”¶ç”¨æˆ·ä¸Šä¼ çš„ `.docx` æ¨¡æ¿æ–‡ä»¶
2. æå–çº¯æ–‡æœ¬å†…å®¹ï¼ˆæŒ‰é˜…è¯»é¡ºåºï¼‰
3. ä¿ç•™æ–‡æ¡£ç»“æ„ä¿¡æ¯ï¼ˆæ®µè½ã€è¡¨æ ¼ã€æ ·å¼ï¼‰
4. è¯†åˆ«æ–‡æ¡£å…ƒæ•°æ®

**æ ¸å¿ƒä»£ç ç¤ºä¾‹**:
```python
from docx import Document
from typing import Dict, List, Any

class DocumentParser:
    def __init__(self, file_path: str):
        self.doc = Document(file_path)
    
    def extract_text(self) -> str:
        """æå–æ–‡æ¡£å…¨æ–‡"""
        full_text = []
        
        # æå–æ®µè½æ–‡æœ¬
        for para in self.doc.paragraphs:
            if para.text.strip():
                full_text.append(para.text)
        
        # æå–è¡¨æ ¼æ–‡æœ¬
        for table in self.doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    if cell.text.strip():
                        full_text.append(cell.text)
        
        return "\n".join(full_text)
    
    def get_structure(self) -> Dict[str, Any]:
        """è·å–æ–‡æ¡£ç»“æ„"""
        return {
            "paragraphs_count": len(self.doc.paragraphs),
            "tables_count": len(self.doc.tables),
            "sections_count": len(self.doc.sections)
        }
```

**API ç«¯ç‚¹**:
```
POST /api/v1/documents/parse
- è¾“å…¥: multipart/form-data (docx file)
- è¾“å‡º: {
    "text": "å…¨æ–‡æ–‡æœ¬å†…å®¹",
    "structure": {...},
    "metadata": {...}
  }
```

---

### æ¨¡å—äºŒï¼šAI å˜é‡æå–æœåŠ¡ (Variable Extractor)

**æŠ€æœ¯æ ˆ**: `LangExtract` + `Gemini API`

**åŠŸèƒ½èŒè´£**:
1. æ¥æ”¶çº¯æ–‡æœ¬å†…å®¹
2. ä½¿ç”¨ LangExtract è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹
3. è¯†åˆ«åˆåŒä¸­çš„å…³é”®å˜é‡å­—æ®µ
4. è¿”å›ç»“æ„åŒ–çš„å˜é‡åˆ—è¡¨ï¼ˆJSON Schemaï¼‰

**æ ¸å¿ƒå®ç°**:
```python
from langextract import LangExtract
from typing import List, Dict

class VariableExtractor:
    def __init__(self, api_key: str, model: str = "gemini-2.5-flash"):
        self.extractor = LangExtract(api_key=api_key, model=model)
    
    def extract_variables(self, text: str) -> List[Dict]:
        """æå–åˆåŒå˜é‡"""
        prompt = """
        åˆ†æä»¥ä¸‹åˆåŒæ–‡æœ¬ï¼Œæå–æ‰€æœ‰éœ€è¦å¡«å†™çš„å˜é‡å­—æ®µã€‚
        å¯¹äºæ¯ä¸ªå˜é‡ï¼Œè¿”å›ï¼š
        - name: å˜é‡åç§°ï¼ˆè‹±æ–‡æ ‡è¯†ç¬¦ï¼‰
        - label: æ˜¾ç¤ºæ ‡ç­¾ï¼ˆä¸­æ–‡ï¼‰
        - type: æ•°æ®ç±»å‹ (text/number/date/boolean/select)
        - required: æ˜¯å¦å¿…å¡«
        - default: é»˜è®¤å€¼ï¼ˆå¦‚æœ‰ï¼‰
        - options: é€‰é¡¹åˆ—è¡¨ï¼ˆå¦‚æœæ˜¯selectç±»å‹ï¼‰
        
        åˆåŒæ–‡æœ¬ï¼š
        {text}
        """
        
        schema = {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {"type": "string"},
                    "label": {"type": "string"},
                    "type": {"type": "string", "enum": ["text", "number", "date", "boolean", "select"]},
                    "required": {"type": "boolean"},
                    "default": {"type": "string"},
                    "options": {"type": "array", "items": {"type": "string"}}
                },
                "required": ["name", "label", "type"]
            }
        }
        
        result = self.extractor.extract(
            prompt=prompt.format(text=text),
            schema=schema
        )
        
        return result
```

**API ç«¯ç‚¹**:
```
POST /api/v1/variables/extract
- è¾“å…¥: {"text": "åˆåŒå…¨æ–‡", "examples": [...]}
- è¾“å‡º: {
    "variables": [
      {
        "name": "party_a",
        "label": "ç”²æ–¹åç§°",
        "type": "text",
        "required": true
      },
      {
        "name": "contract_date",
        "label": "ç­¾è®¢æ—¥æœŸ",
        "type": "date",
        "required": true
      },
      ...
    ]
  }
```

---

### æ¨¡å—ä¸‰ï¼šåŠ¨æ€è¡¨å•ç”Ÿæˆ (Form Generator)

**æŠ€æœ¯æ ˆ**: React Hook Form + Zod (å‰ç«¯) + FastAPI (åç«¯)

**åŠŸèƒ½èŒè´£**:
1. æ ¹æ®å˜é‡åˆ—è¡¨åŠ¨æ€ç”Ÿæˆå‰ç«¯è¡¨å•
2. å®ç°è¡¨å•éªŒè¯é€»è¾‘
3. å¤„ç†ç”¨æˆ·è¾“å…¥æ•°æ®
4. æ˜ å°„æ•°æ®åˆ°æ–‡æ¡£å ä½ç¬¦

**å‰ç«¯å®ç°ç¤ºä¾‹**:
```typescript
// src/components/DynamicForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';

interface Variable {
  name: string;
  label: string;
  type: 'text' | 'number' | 'date' | 'boolean' | 'select';
  required: boolean;
  options?: string[];
}

export function DynamicForm({ variables, onSubmit }: Props) {
  // åŠ¨æ€ç”Ÿæˆ Zod Schema
  const schemaShape: any = {};
  variables.forEach(v => {
    let field = z.string();
    if (v.type === 'number') field = z.number();
    if (v.type === 'date') field = z.date();
    if (v.required) field = field.min(1, `${v.label}å¿…å¡«`);
    schemaShape[v.name] = field;
  });
  
  const schema = z.object(schemaShape);
  const { register, handleSubmit, formState: { errors } } = useForm({
    resolver: zodResolver(schema)
  });
  
  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      {variables.map(variable => (
        <div key={variable.name}>
          <label>{variable.label}</label>
          {variable.type === 'text' && (
            <input {...register(variable.name)} type="text" />
          )}
          {variable.type === 'date' && (
            <input {...register(variable.name)} type="date" />
          )}
          {variable.type === 'select' && (
            <select {...register(variable.name)}>
              {variable.options?.map(opt => (
                <option key={opt} value={opt}>{opt}</option>
              ))}
            </select>
          )}
          {errors[variable.name] && (
            <span className="error">{errors[variable.name]?.message}</span>
          )}
        </div>
      ))}
      <button type="submit">ç”ŸæˆåˆåŒ</button>
    </form>
  );
}
```

**åç«¯æ•°æ®éªŒè¯**:
```python
from pydantic import BaseModel, validator
from typing import Dict, Any

class FormData(BaseModel):
    template_id: str
    variables: Dict[str, Any]
    
    @validator('variables')
    def validate_variables(cls, v, values):
        # æ ¹æ®æ¨¡æ¿å®šä¹‰éªŒè¯æ•°æ®
        return v
```

---

### æ¨¡å—å››ï¼šé«˜ä¿çœŸæ–‡æ¡£ç”Ÿæˆ (Document Generator)

**æŠ€æœ¯æ ˆ**: `python-docx-template` (Jinja2)

**åŠŸèƒ½èŒè´£**:
1. æ¥æ”¶ç”¨æˆ·å¡«å†™çš„æ•°æ®å’ŒåŸå§‹æ¨¡æ¿
2. å°†æ•°æ®æ¸²æŸ“åˆ° Jinja2 æ¨¡æ¿ä¸­
3. ç”Ÿæˆæœ€ç»ˆçš„ `.docx` æ–‡æ¡£
4. **å…³é”®**ï¼šä¿æŒåŸå§‹æ¨¡æ¿çš„æ‰€æœ‰æ ¼å¼

**æ ¸å¿ƒå®ç°**:
```python
from docxtpl import DocxTemplate
from typing import Dict, Any
import io

class DocumentGenerator:
    def __init__(self, template_path: str):
        self.template = DocxTemplate(template_path)
    
    def render(self, context: Dict[str, Any]) -> bytes:
        """æ¸²æŸ“æ–‡æ¡£"""
        # å¡«å……æ•°æ®
        self.template.render(context)
        
        # ä¿å­˜åˆ°å†…å­˜
        file_stream = io.BytesIO()
        self.template.save(file_stream)
        file_stream.seek(0)
        
        return file_stream.getvalue()
    
    def render_with_tables(self, context: Dict[str, Any], 
                          table_data: Dict[str, List[Dict]]) -> bytes:
        """æ¸²æŸ“åŒ…å«è¡¨æ ¼æ•°æ®çš„æ–‡æ¡£"""
        # åˆå¹¶ä¸Šä¸‹æ–‡å’Œè¡¨æ ¼æ•°æ®
        full_context = {**context, **table_data}
        return self.render(full_context)
```

**æ¨¡æ¿æ ¼å¼ç¤ºä¾‹**:
```
åˆåŒç¼–å·ï¼š{{ contract_number }}
ç”²æ–¹ï¼š{{ party_a }}
ä¹™æ–¹ï¼š{{ party_b }}
ç­¾è®¢æ—¥æœŸï¼š{{ contract_date }}

{% for item in items %}
{{ loop.index }}. {{ item.name }} - {{ item.price }}å…ƒ
{% endfor %}
```

**API ç«¯ç‚¹**:
```
POST /api/v1/documents/generate
- è¾“å…¥: {
    "template_id": "uuid",
    "data": {
      "party_a": "æŸæŸå…¬å¸",
      "contract_date": "2025-01-10",
      ...
    }
  }
- è¾“å‡º: äºŒè¿›åˆ¶æ–‡ä»¶æµ (application/vnd.openxmlformats-officedocument.wordprocessingml.document)
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- æ¨¡æ¿è¡¨
CREATE TABLE templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    file_url TEXT NOT NULL,  -- Vercel Blob URL
    storage_key TEXT NOT NULL,
    
    -- å…ƒæ•°æ®
    file_size INTEGER,
    mime_type VARCHAR(100),
    
    -- æ¨¡æ¿ä¿¡æ¯
    variables JSONB,  -- å­˜å‚¨å˜é‡å®šä¹‰
    structure JSONB,  -- å­˜å‚¨æ–‡æ¡£ç»“æ„
    
    -- çŠ¶æ€
    status VARCHAR(50) DEFAULT 'active',  -- active, archived, deleted
    is_public BOOLEAN DEFAULT false,
    
    -- ç»Ÿè®¡
    usage_count INTEGER DEFAULT 0,
    last_used_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ç”Ÿæˆè®°å½•è¡¨
CREATE TABLE generated_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    template_id UUID NOT NULL REFERENCES templates(id),
    
    -- è¾“å…¥æ•°æ®
    input_data JSONB NOT NULL,
    
    -- è¾“å‡ºæ–‡ä»¶
    output_url TEXT NOT NULL,  -- Vercel Blob URL
    storage_key TEXT NOT NULL,
    file_size INTEGER,
    
    -- å…ƒæ•°æ®
    generation_time INTEGER,  -- æ¯«ç§’
    status VARCHAR(50) DEFAULT 'completed',  -- pending, completed, failed
    error_message TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- å˜é‡æå–ç¼“å­˜è¡¨ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
CREATE TABLE variable_cache (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID NOT NULL REFERENCES templates(id),
    text_hash VARCHAR(64) NOT NULL,  -- æ–‡æœ¬å†…å®¹çš„ SHA-256
    variables JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(template_id, text_hash)
);
```

---

## ğŸš€ å®Œæ•´å·¥ä½œæµç¨‹

### ç”¨æˆ·è§†è§’æµç¨‹

```
1. ä¸Šä¼ æ¨¡æ¿
   â†“
2. ç³»ç»Ÿè§£ææ¨¡æ¿ï¼Œæå–å˜é‡
   â†“
3. æ˜¾ç¤ºåŠ¨æ€ç”Ÿæˆçš„è¡¨å•
   â†“
4. ç”¨æˆ·å¡«å†™è¡¨å•æ•°æ®
   â†“
5. ç‚¹å‡»"ç”ŸæˆåˆåŒ"
   â†“
6. ç³»ç»Ÿç”Ÿæˆ .docx æ–‡ä»¶
   â†“
7. ç”¨æˆ·ä¸‹è½½æˆå“åˆåŒ
```

### æŠ€æœ¯å®ç°æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant API
    participant Parser
    participant Extractor
    participant Generator
    participant Storage

    User->>Frontend: ä¸Šä¼  .docx æ¨¡æ¿
    Frontend->>API: POST /api/v1/templates/upload
    API->>Storage: ä¿å­˜åŸå§‹æ–‡ä»¶
    Storage-->>API: è¿”å›æ–‡ä»¶ URL
    API->>Parser: è§£ææ–‡æ¡£ç»“æ„
    Parser-->>API: è¿”å›çº¯æ–‡æœ¬ + ç»“æ„
    API->>Extractor: æå–å˜é‡
    Extractor-->>API: è¿”å›å˜é‡åˆ—è¡¨
    API->>Storage: ä¿å­˜æ¨¡æ¿å…ƒæ•°æ®
    API-->>Frontend: è¿”å›æ¨¡æ¿ ID + å˜é‡åˆ—è¡¨
    Frontend->>User: æ˜¾ç¤ºåŠ¨æ€è¡¨å•
    
    User->>Frontend: å¡«å†™å¹¶æäº¤è¡¨å•
    Frontend->>API: POST /api/v1/documents/generate
    API->>Storage: è·å–åŸå§‹æ¨¡æ¿
    API->>Generator: æ¸²æŸ“æ–‡æ¡£
    Generator-->>API: è¿”å›ç”Ÿæˆçš„æ–‡ä»¶
    API->>Storage: ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶
    Storage-->>API: è¿”å›æ–‡ä»¶ URL
    API-->>Frontend: è¿”å›ä¸‹è½½é“¾æ¥
    Frontend->>User: è§¦å‘ä¸‹è½½
```

---

## ğŸ“¦ æŠ€æœ¯æ ˆæ€»è§ˆ

### Python åç«¯ (FastAPI)

```txt
# requirements.txt
fastapi==0.115.0
uvicorn[standard]==0.30.0
python-multipart==0.0.12
python-docx==1.1.2
python-docx-template==0.16.7
langextract==0.1.0  # å‡è®¾ç‰ˆæœ¬
pydantic==2.9.0
sqlalchemy==2.0.35
psycopg2-binary==2.9.9
alembic==1.13.3
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-dotenv==1.0.1
aiofiles==24.1.0
httpx==0.27.2
```

### å‰ç«¯ (Next.js)

```json
{
  "dependencies": {
    "next": "14.2.5",
    "react": "^18",
    "react-dom": "^18",
    "react-hook-form": "^7.52.1",
    "@hookform/resolvers": "^3.7.0",
    "zod": "^3.23.8",
    "axios": "^1.7.2",
    "zustand": "^4.5.4",
    "tailwindcss": "^3.4.1",
    "lucide-react": "^0.408.0"
  }
}
```

---

## ğŸ”„ åˆ†é˜¶æ®µè¿ç§»è®¡åˆ’

### Phase 1: Python åç«¯åŸºç¡€æ­å»ºï¼ˆç¬¬1-2å‘¨ï¼‰

**ç›®æ ‡**: å»ºç«‹ç‹¬ç«‹çš„ Python FastAPI åç«¯æœåŠ¡

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆå§‹åŒ– FastAPI é¡¹ç›®ç»“æ„
- [ ] é…ç½®æ•°æ®åº“è¿æ¥ï¼ˆå¤ç”¨ Vercel Postgresï¼‰
- [ ] å®ç°ç”¨æˆ·è®¤è¯ JWT ä¸­é—´ä»¶
- [ ] æ­å»ºæ–‡ä»¶ä¸Šä¼ /ä¸‹è½½åŸºç¡€è®¾æ–½
- [ ] **æ¨¡å—ä¸€**: å®ç°æ–‡æ¡£è§£ææœåŠ¡
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
```bash
curl -X POST http://localhost:8000/api/v1/documents/parse \
  -F "file=@template.docx" \
  -H "Authorization: Bearer <token>"
```

---

### Phase 2: AI å˜é‡æå–é›†æˆï¼ˆç¬¬3å‘¨ï¼‰

**ç›®æ ‡**: é›†æˆ LangExtract å’Œ Gemini API

**ä»»åŠ¡æ¸…å•**:
- [ ] æ³¨å†Œå¹¶é…ç½® LangExtract API Key
- [ ] **æ¨¡å—äºŒ**: å®ç°å˜é‡æå–æœåŠ¡
- [ ] è®¾è®¡å˜é‡æå–çš„ Prompt æ¨¡æ¿
- [ ] å®ç°æå–ç»“æœç¼“å­˜æœºåˆ¶
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
```bash
curl -X POST http://localhost:8000/api/v1/variables/extract \
  -H "Content-Type: application/json" \
  -d '{"text": "åˆåŒå…¨æ–‡..."}'
```

---

### Phase 3: æ–‡æ¡£ç”Ÿæˆå¼•æ“ï¼ˆç¬¬4å‘¨ï¼‰

**ç›®æ ‡**: å®ç°é«˜ä¿çœŸæ–‡æ¡£ç”Ÿæˆ

**ä»»åŠ¡æ¸…å•**:
- [ ] **æ¨¡å—å››**: é›†æˆ python-docx-template
- [ ] å®ç° Jinja2 æ¨¡æ¿æ¸²æŸ“
- [ ] æ”¯æŒè¡¨æ ¼åŠ¨æ€æ•°æ®
- [ ] å®ç°æ–‡æ¡£é¢„è§ˆåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†

**éªŒæ”¶æ ‡å‡†**:
```bash
curl -X POST http://localhost:8000/api/v1/documents/generate \
  -H "Content-Type: application/json" \
  -d '{
    "template_id": "uuid",
    "data": {"party_a": "æµ‹è¯•å…¬å¸", ...}
  }' \
  --output generated.docx
```

---

### Phase 4: å‰ç«¯é‡æ„ï¼ˆç¬¬5-6å‘¨ï¼‰

**ç›®æ ‡**: é‡æ„ Next.js å‰ç«¯ï¼Œå¯¹æ¥æ–°åç«¯

**ä»»åŠ¡æ¸…å•**:
- [ ] æ¸…ç†æ—§çš„é£ä¹¦é›†æˆä»£ç 
- [ ] **æ¨¡å—ä¸‰**: å®ç°åŠ¨æ€è¡¨å•ç”Ÿæˆç»„ä»¶
- [ ] é‡æ„ä¸Šä¼ æµç¨‹ UI
- [ ] å®ç°æ¨¡æ¿ç®¡ç†ç•Œé¢
- [ ] ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼ˆåŠ è½½çŠ¶æ€ã€é”™è¯¯æç¤ºï¼‰
- [ ] å“åº”å¼è®¾è®¡é€‚é…

**å…³é”®ç»„ä»¶**:
```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â””â”€â”€ login/page.tsx
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â”œâ”€â”€ page.tsx          # æ¨¡æ¿åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ upload/page.tsx   # ä¸Šä¼ æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ [id]/page.tsx     # æ¨¡æ¿è¯¦æƒ… + è¡¨å•
â”‚   â””â”€â”€ documents/
â”‚       â””â”€â”€ page.tsx           # ç”Ÿæˆè®°å½•
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ DynamicForm.tsx        # åŠ¨æ€è¡¨å•
â”‚   â”œâ”€â”€ TemplateUploader.tsx   # ä¸Šä¼ ç»„ä»¶
â”‚   â””â”€â”€ DocumentViewer.tsx     # é¢„è§ˆç»„ä»¶
â””â”€â”€ lib/
    â”œâ”€â”€ api-client.ts          # åç«¯ API è°ƒç”¨
    â””â”€â”€ form-builder.ts        # è¡¨å•æ„å»ºé€»è¾‘
```

---

### Phase 5: é›†æˆæµ‹è¯•ä¸éƒ¨ç½²ï¼ˆç¬¬7å‘¨ï¼‰

**ç›®æ ‡**: ç«¯åˆ°ç«¯æµ‹è¯•å’Œç”Ÿäº§éƒ¨ç½²

**ä»»åŠ¡æ¸…å•**:
- [ ] ç¼–å†™ E2E æµ‹è¯•ï¼ˆPlaywrightï¼‰
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] é…ç½® Leaflow éƒ¨ç½²ç¯å¢ƒ
- [ ] é…ç½® CORS å’Œå®‰å…¨ç­–ç•¥
- [ ] å‡†å¤‡ç”Ÿäº§ç¯å¢ƒå˜é‡
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] ç›‘æ§å’Œæ—¥å¿—é…ç½®

**Leaflow éƒ¨ç½²é…ç½®**:
```yaml
# leaflow.yaml
name: contract-backend
runtime: python3.11
entry: main:app
env:
  - DATABASE_URL=${POSTGRES_URL}
  - GEMINI_API_KEY=${GEMINI_API_KEY}
  - JWT_SECRET=${JWT_SECRET}
  - BLOB_READ_WRITE_TOKEN=${BLOB_TOKEN}
```

---

### Phase 6: é«˜çº§åŠŸèƒ½ï¼ˆç¬¬8å‘¨+ï¼‰

**ç›®æ ‡**: å®ç° Phase 2 å’Œ Phase 3 åŠŸèƒ½

**ä»»åŠ¡æ¸…å•**:
- [ ] è¡¨æ ¼æ•°æ®æ‰¹é‡å¡«å……
- [ ] æ—¥æœŸé€‰æ‹©å™¨ã€ä¸‹æ‹‰é€‰æ‹©ç­‰é«˜çº§è¾“å…¥
- [ ] æ¨¡æ¿åº“å’Œç‰ˆæœ¬ç®¡ç†
- [ ] PDF å¯¼å‡ºåŠŸèƒ½ï¼ˆä½¿ç”¨ LibreOffice APIï¼‰
- [ ] è‡ªç„¶è¯­è¨€å¡«å……ï¼ˆGemini é›†æˆï¼‰
- [ ] æ™ºèƒ½æ¡æ¬¾ç”Ÿæˆ

---

## ğŸŒ éƒ¨ç½²æ¶æ„

### Leaflow (Python åç«¯)

```
https://api.your-domain.com
â”œâ”€â”€ /api/v1/auth/*           # è®¤è¯ç›¸å…³
â”œâ”€â”€ /api/v1/templates/*      # æ¨¡æ¿ç®¡ç†
â”œâ”€â”€ /api/v1/documents/*      # æ–‡æ¡£å¤„ç†
â”œâ”€â”€ /api/v1/variables/*      # å˜é‡æå–
â””â”€â”€ /health                  # å¥åº·æ£€æŸ¥
```

**ç¯å¢ƒå˜é‡**:
```env
# Leaflow ç¯å¢ƒå˜é‡
DATABASE_URL=postgresql://...
POSTGRES_PRISMA_URL=postgresql://...
GEMINI_API_KEY=...
LANGEXTRACT_API_KEY=...
JWT_SECRET=...
BLOB_READ_WRITE_TOKEN=...
CORS_ORIGINS=https://your-app.vercel.app
```

---

### Vercel (Next.js å‰ç«¯)

```
https://your-app.vercel.app
â”œâ”€â”€ /                        # é¦–é¡µ
â”œâ”€â”€ /templates               # æ¨¡æ¿ç®¡ç†
â”œâ”€â”€ /templates/upload        # ä¸Šä¼ æ¨¡æ¿
â”œâ”€â”€ /templates/:id           # å¡«å†™è¡¨å•
â””â”€â”€ /documents               # ç”Ÿæˆè®°å½•
```

**ç¯å¢ƒå˜é‡**:
```env
# Vercel ç¯å¢ƒå˜é‡
NEXT_PUBLIC_API_URL=https://api.your-domain.com
NEXT_PUBLIC_APP_NAME=æ™ºèƒ½åˆåŒ
```

---

### æ•°æ®åº“ (Vercel Postgres)

ä¿æŒå½“å‰æ•°æ®åº“ï¼Œæ·»åŠ æ–°è¡¨ï¼š
- `templates`
- `generated_documents`
- `variable_cache`

å¯é€‰æ‹©ä¿ç•™éƒ¨åˆ†æ—§è¡¨ç”¨äºç”¨æˆ·ç®¡ç†ã€‚

---

### æ–‡ä»¶å­˜å‚¨ (Vercel Blob)

**å­˜å‚¨ç»“æ„**:
```
/templates/:user_id/:template_id/original.docx
/templates/:user_id/:template_id/preview.png
/generated/:user_id/:document_id.docx
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### åç«¯å®‰å…¨

1. **è®¤è¯**: JWT Tokenï¼Œæœ‰æ•ˆæœŸ 7 å¤©
2. **æˆæƒ**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
3. **æ–‡ä»¶éªŒè¯**:
   - æ–‡ä»¶ç±»å‹ç™½åå•ï¼ˆä»… `.docx`ï¼‰
   - æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ10MBï¼‰
   - ç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼‰
4. **è¾“å…¥éªŒè¯**: Pydantic ä¸¥æ ¼éªŒè¯
5. **Rate Limiting**: æ¯ç”¨æˆ·æ¯åˆ†é’Ÿ 60 æ¬¡è¯·æ±‚

### å‰ç«¯å®‰å…¨

1. **HTTPS**: å¼ºåˆ¶ä½¿ç”¨ HTTPS
2. **XSS é˜²æŠ¤**: React è‡ªåŠ¨è½¬ä¹‰
3. **CSRF é˜²æŠ¤**: SameSite Cookie
4. **æ•æ„Ÿæ•°æ®**: ä¸åœ¨å‰ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### åç«¯ä¼˜åŒ–

1. **ç¼“å­˜ç­–ç•¥**:
   - å˜é‡æå–ç»“æœç¼“å­˜ï¼ˆRedisï¼‰
   - æ¨¡æ¿å…ƒæ•°æ®ç¼“å­˜
2. **å¼‚æ­¥å¤„ç†**:
   - å¤§æ–‡ä»¶å¤„ç†ä½¿ç”¨åå°ä»»åŠ¡ï¼ˆCeleryï¼‰
3. **è¿æ¥æ± **:
   - æ•°æ®åº“è¿æ¥æ± é…ç½®
4. **æ–‡ä»¶æµå¼ä¼ è¾“**:
   - å¤§æ–‡ä»¶ä¸‹è½½ä½¿ç”¨æµå¼å“åº”

### å‰ç«¯ä¼˜åŒ–

1. **ä»£ç åˆ†å‰²**: Next.js è‡ªåŠ¨åˆ†å‰²
2. **å›¾ç‰‡ä¼˜åŒ–**: Next.js Image ç»„ä»¶
3. **é¢„åŠ è½½**: å…³é”®èµ„æºé¢„åŠ è½½
4. **ç¼“å­˜**: SWR æˆ– React Query

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### åç«¯æµ‹è¯•

```python
# tests/test_document_parser.py
def test_parse_simple_document():
    parser = DocumentParser("test.docx")
    text = parser.extract_text()
    assert "ç”²æ–¹" in text
    
def test_extract_variables():
    extractor = VariableExtractor(api_key="...")
    variables = extractor.extract_variables("åˆåŒæ–‡æœ¬...")
    assert len(variables) > 0
    assert variables[0]["name"] == "party_a"
```

### å‰ç«¯æµ‹è¯•

```typescript
// tests/e2e/upload-template.spec.ts
test('should upload template and see form', async ({ page }) => {
  await page.goto('/templates/upload');
  await page.setInputFiles('input[type=file]', 'test.docx');
  await page.click('button[type=submit]');
  await expect(page.locator('form')).toBeVisible();
});
```

---

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### åç«¯æ—¥å¿—

```python
import logging

logger = logging.getLogger(__name__)

@app.post("/api/v1/documents/generate")
async def generate_document(data: GenerateRequest):
    logger.info(f"Generate document: template_id={data.template_id}")
    try:
        result = await generator.render(data)
        logger.info(f"Document generated successfully: {result.id}")
        return result
    except Exception as e:
        logger.error(f"Generate failed: {str(e)}", exc_info=True)
        raise
```

### å‰ç«¯ç›‘æ§

- Vercel Analytics
- Sentry é”™è¯¯è¿½è¸ª
- ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆå¯é€‰ï¼‰

---

## ğŸ“ è¿ç§»æ£€æŸ¥æ¸…å•

### ä»£ç è¿ç§»

- [ ] åˆ›å»º Python FastAPI é¡¹ç›®
- [ ] å®‰è£…æ‰€æœ‰ä¾èµ–
- [ ] å®ç°å››å¤§æ ¸å¿ƒæ¨¡å—
- [ ] é‡æ„å‰ç«¯ä»£ç 
- [ ] ç§»é™¤é£ä¹¦ç›¸å…³ä»£ç 
- [ ] æ›´æ–°ç¯å¢ƒå˜é‡

### æ•°æ®åº“è¿ç§»

- [ ] åˆ›å»ºæ–°è¡¨ç»“æ„
- [ ] ï¼ˆå¯é€‰ï¼‰è¿ç§»ç”¨æˆ·æ•°æ®
- [ ] æ›´æ–° Prisma Schema
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»

### éƒ¨ç½²è¿ç§»

- [ ] æ³¨å†Œ Leaflow è´¦å·
- [ ] é…ç½® Leaflow é¡¹ç›®
- [ ] é…ç½®ç¯å¢ƒå˜é‡
- [ ] éƒ¨ç½²åç«¯æœåŠ¡
- [ ] æ›´æ–° Vercel å‰ç«¯é…ç½®
- [ ] æµ‹è¯•ç”Ÿäº§ç¯å¢ƒ

### æµ‹è¯•éªŒè¯

- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] E2E æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] å®‰å…¨æµ‹è¯•é€šè¿‡

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### Phase 1 MVP

- ç”¨æˆ·å¯ä»¥ä¸Šä¼ æ¨¡æ¿
- ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å˜é‡
- ç”¨æˆ·å¯ä»¥å¡«å†™è¡¨å•
- ç³»ç»Ÿç”Ÿæˆå¹¶ä¸‹è½½åˆåŒ
- å¹³å‡å“åº”æ—¶é—´ < 3ç§’

### Phase 2 å¢å¼º

- æ”¯æŒè¡¨æ ¼æ•°æ®
- æ”¯æŒ5ç§ä»¥ä¸Šæ•°æ®ç±»å‹
- æ¨¡æ¿åº“åŠŸèƒ½
- PDF å¯¼å‡ºåŠŸèƒ½
- ç”¨æˆ·æ»¡æ„åº¦ > 85%

### Phase 3 AIèµ‹èƒ½

- è‡ªç„¶è¯­è¨€å¡«å……å‡†ç¡®ç‡ > 90%
- æ™ºèƒ½æ¡æ¬¾ç”Ÿæˆè´¨é‡è¯„åˆ† > 4/5
- ç³»ç»Ÿé‡‡ç”¨ç‡ > 70%

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å…³é”®ä¾èµ–æ–‡æ¡£

- [python-docx æ–‡æ¡£](https://python-docx.readthedocs.io/)
- [python-docx-template æ–‡æ¡£](https://docxtpl.readthedocs.io/)
- [LangExtract æ–‡æ¡£](å¾…è¡¥å……)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Next.js æ–‡æ¡£](https://nextjs.org/docs)

### å¼€å‘å›¢é˜Ÿè”ç³»æ–¹å¼

- åç«¯å¼€å‘: [å¾…å¡«å†™]
- å‰ç«¯å¼€å‘: [å¾…å¡«å†™]
- DevOps: [å¾…å¡«å†™]

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ10æ—¥  
**ä¸‹æ¬¡å®¡æŸ¥**: 2025å¹´2æœˆ10æ—¥
